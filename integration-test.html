<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVUæ‰©å±•é›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 {
            color: #4a9eff;
            border-bottom: 2px solid #4a9eff;
            padding-bottom: 10px;
        }
        h2 {
            color: #66bb6a;
            margin-top: 30px;
        }
        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #3a3a3a;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 4px;
        }
        .test-button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #3a8eef;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #1b5e20;
            color: #a5d6a7;
            border: 1px solid #4caf50;
        }
        .error {
            background: #b71c1c;
            color: #ffcdd2;
            border: 1px solid #f44336;
        }
        .warning {
            background: #f57c00;
            color: #ffe0b2;
            border: 1px solid #ff9800;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            background: #444;
            color: white;
            border: 1px solid #666;
            border-radius: 4px;
            margin: 5px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-pass { background: #4caf50; }
        .status-fail { background: #f44336; }
        .status-pending { background: #ff9800; }
    </style>
</head>
<body>
    <h1>ğŸ§ª MVUæ‰©å±•é›†æˆæµ‹è¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•ç¯å¢ƒæ£€æŸ¥</h2>
        <div class="test-item">
            <button class="test-button" onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
            <div id="env-result" class="result"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ å˜é‡å¤„ç†å™¨æµ‹è¯•</h2>
        
        <div class="test-item">
            <h3>å‘½ä»¤è§£ææµ‹è¯•</h3>
            <textarea id="command-input" rows="3" placeholder="è¾“å…¥MVUå‘½ä»¤ï¼Œå¦‚: _.set('player.hp', 100);">_.set('player.hp', 100); // è®¾ç½®ç”Ÿå‘½å€¼
_.insert('inventory', 'sword'); // æ·»åŠ ç‰©å“
_.add('player.level', 1); // å‡çº§</textarea>
            <button class="test-button" onclick="testCommandParsing()">æµ‹è¯•è§£æ</button>
            <div id="parse-result" class="result"></div>
        </div>

        <div class="test-item">
            <h3>å˜é‡æ‰§è¡Œæµ‹è¯•</h3>
            <button class="test-button" onclick="testCommandExecution()">æ‰§è¡Œå‘½ä»¤</button>
            <div id="exec-result" class="result"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“š ä¸–ç•Œä¹¦å¤„ç†æµ‹è¯•</h2>
        
        <div class="test-item">
            <h3>InitVarè§£ææµ‹è¯•</h3>
            <textarea id="initvar-input" rows="5" placeholder="è¾“å…¥InitVarå†…å®¹ï¼ˆYAML/JSONï¼‰">player:
  name: "æµ‹è¯•ç©å®¶"
  hp: 100
  level: 1
npc:
  affection: 0</textarea>
            <button class="test-button" onclick="testInitVarParsing()">æµ‹è¯•è§£æ</button>
            <div id="initvar-result" class="result"></div>
        </div>

        <div class="test-item">
            <h3>UpdateVariableå—æµ‹è¯•</h3>
            <textarea id="update-block-input" rows="6" placeholder="è¾“å…¥UpdateVariableå—"><UpdateVariable>
<Analysis>æˆ˜æ–—ç»“æŸï¼Œæ›´æ–°çŠ¶æ€</Analysis>
_.set('player.hp', 75);
_.add('player.exp', 50);
</UpdateVariable></textarea>
            <button class="test-button" onclick="testUpdateBlock()">æµ‹è¯•è§£æ</button>
            <div id="update-block-result" class="result"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ å…¼å®¹æ€§æµ‹è¯•å¥—ä»¶</h2>
        <button class="test-button" onclick="runAllTests()">è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
        <div id="test-suite-result" class="result"></div>
    </div>

    <script>
        // æ¨¡æ‹ŸMVUæ¨¡å—
        class MockVariableProcessor {
            constructor() {
                this.variables = {
                    stat_data: {},
                    display_data: {},
                    delta_data: {}
                };
            }
            
            parseCommands(text) {
                const commands = [];
                const regex = /_\.(set|insert|assign|remove|unset|delete|add)\s*\(/g;
                let match;
                
                while ((match = regex.exec(text)) !== null) {
                    const type = match[1];
                    const start = match.index;
                    const argsStart = start + match[0].length;
                    
                    // ç®€åŒ–çš„å‚æ•°æå–
                    let depth = 1;
                    let end = argsStart;
                    
                    for (let i = argsStart; i < text.length && depth > 0; i++) {
                        if (text[i] === '(') depth++;
                        if (text[i] === ')') depth--;
                        if (depth === 0) end = i;
                    }
                    
                    const argsText = text.substring(argsStart, end);
                    const fullMatch = text.substring(start, end + 1);
                    
                    // æŸ¥æ‰¾æ³¨é‡Š
                    let reason = '';
                    const commentMatch = text.substring(end + 1).match(/;\s*\/\/(.*?)$/m);
                    if (commentMatch) {
                        reason = commentMatch[1].trim();
                    }
                    
                    commands.push({
                        type,
                        fullMatch: fullMatch + (commentMatch ? commentMatch[0] : ''),
                        args: this.parseArgs(argsText),
                        reason
                    });
                }
                
                return commands;
            }
            
            parseArgs(argsText) {
                // ç®€åŒ–çš„å‚æ•°è§£æ
                const args = [];
                let current = '';
                let inString = false;
                let stringChar = '';
                let depth = 0;
                
                for (let i = 0; i < argsText.length; i++) {
                    const char = argsText[i];
                    
                    if ((char === '"' || char === "'") && (i === 0 || argsText[i-1] !== '\\')) {
                        if (!inString) {
                            inString = true;
                            stringChar = char;
                        } else if (char === stringChar) {
                            inString = false;
                        }
                    }
                    
                    if (!inString) {
                        if (char === ',' && depth === 0) {
                            args.push(current.trim());
                            current = '';
                            continue;
                        }
                        if (char === '(' || char === '[' || char === '{') depth++;
                        if (char === ')' || char === ']' || char === '}') depth--;
                    }
                    
                    current += char;
                }
                
                if (current.trim()) {
                    args.push(current.trim());
                }
                
                return args;
            }
        }

        class MockWorldbookHandler {
            parseUpdateVariableBlock(text) {
                const blocks = [];
                const regex = /<UpdateVariable>([\s\S]*?)<\/UpdateVariable>/g;
                let match;
                
                while ((match = regex.exec(text)) !== null) {
                    const content = match[1];
                    let analysis = '';
                    
                    const analysisMatch = content.match(/<Analy[sz]e?>([\s\S]*?)<\/Analy[sz]e?>/i);
                    if (analysisMatch) {
                        analysis = analysisMatch[1].trim();
                    }
                    
                    const commands = content.replace(/<Analy[sz]e?>[\s\S]*?<\/Analy[sz]e?>/i, '').trim();
                    
                    blocks.push({
                        analysis,
                        commands,
                        fullMatch: match[0]
                    });
                }
                
                return blocks;
            }
            
            parseInitVarContent(content) {
                try {
                    // å°è¯•JSONè§£æ
                    return JSON.parse(content);
                } catch {
                    // ç®€å•çš„YAMLè§£æ
                    const result = {};
                    const lines = content.split('\n');
                    let currentObj = result;
                    let currentKey = '';
                    
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (!trimmed || trimmed.startsWith('#')) continue;
                        
                        const indent = line.length - line.trimStart().length;
                        
                        if (line.includes(':')) {
                            const [key, ...valueParts] = line.split(':');
                            const value = valueParts.join(':').trim();
                            
                            if (!value || value === '') {
                                currentKey = key.trim();
                                result[currentKey] = {};
                                currentObj = result[currentKey];
                            } else {
                                const cleanValue = value.replace(/['"]/g, '');
                                if (indent === 0) {
                                    result[key.trim()] = isNaN(cleanValue) ? cleanValue : Number(cleanValue);
                                } else {
                                    currentObj[key.trim()] = isNaN(cleanValue) ? cleanValue : Number(cleanValue);
                                }
                            }
                        }
                    }
                    
                    return result;
                }
            }
        }

        // æµ‹è¯•å‡½æ•°
        function checkEnvironment() {
            const result = document.getElementById('env-result');
            const tests = [];
            
            tests.push(`<span class="status-indicator status-pass"></span>æµè§ˆå™¨: ${navigator.userAgent.split(' ').slice(-2).join(' ')}`);
            tests.push(`<span class="status-indicator status-pass"></span>æ—¶é—´: ${new Date().toLocaleString()}`);
            tests.push(`<span class="status-indicator status-pass"></span>MVUç‰ˆæœ¬: 1.0.0`);
            
            result.className = 'result success';
            result.innerHTML = 'ç¯å¢ƒæ£€æŸ¥é€šè¿‡:\n' + tests.join('\n');
        }

        function testCommandParsing() {
            const input = document.getElementById('command-input').value;
            const result = document.getElementById('parse-result');
            
            try {
                const processor = new MockVariableProcessor();
                const commands = processor.parseCommands(input);
                
                result.className = 'result success';
                result.innerHTML = 'è§£ææˆåŠŸ:\n' + JSON.stringify(commands, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = 'è§£æå¤±è´¥: ' + error.message;
            }
        }

        function testCommandExecution() {
            const input = document.getElementById('command-input').value;
            const result = document.getElementById('exec-result');
            
            try {
                const processor = new MockVariableProcessor();
                const commands = processor.parseCommands(input);
                
                // æ¨¡æ‹Ÿæ‰§è¡Œ
                const results = commands.map(cmd => ({
                    command: cmd.type,
                    args: cmd.args,
                    status: 'executed'
                }));
                
                result.className = 'result success';
                result.innerHTML = 'æ‰§è¡ŒæˆåŠŸ:\n' + JSON.stringify(results, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = 'æ‰§è¡Œå¤±è´¥: ' + error.message;
            }
        }

        function testInitVarParsing() {
            const input = document.getElementById('initvar-input').value;
            const result = document.getElementById('initvar-result');
            
            try {
                const handler = new MockWorldbookHandler();
                const parsed = handler.parseInitVarContent(input);
                
                result.className = 'result success';
                result.innerHTML = 'è§£ææˆåŠŸ:\n' + JSON.stringify(parsed, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = 'è§£æå¤±è´¥: ' + error.message;
            }
        }

        function testUpdateBlock() {
            const input = document.getElementById('update-block-input').value;
            const result = document.getElementById('update-block-result');
            
            try {
                const handler = new MockWorldbookHandler();
                const blocks = handler.parseUpdateVariableBlock(input);
                
                result.className = 'result success';
                result.innerHTML = 'è§£ææˆåŠŸ:\n' + JSON.stringify(blocks, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = 'è§£æå¤±è´¥: ' + error.message;
            }
        }

        function runAllTests() {
            const result = document.getElementById('test-suite-result');
            const testResults = [];
            let passed = 0;
            let failed = 0;
            
            // æµ‹è¯•1: å‘½ä»¤è§£æ
            try {
                const processor = new MockVariableProcessor();
                const commands = processor.parseCommands("_.set('test', 123);");
                if (commands.length > 0) {
                    testResults.push('âœ… å‘½ä»¤è§£ææµ‹è¯•é€šè¿‡');
                    passed++;
                }
            } catch {
                testResults.push('âŒ å‘½ä»¤è§£ææµ‹è¯•å¤±è´¥');
                failed++;
            }
            
            // æµ‹è¯•2: InitVarè§£æ
            try {
                const handler = new MockWorldbookHandler();
                const data = handler.parseInitVarContent('{"test": 123}');
                if (data.test === 123) {
                    testResults.push('âœ… InitVarè§£ææµ‹è¯•é€šè¿‡');
                    passed++;
                }
            } catch {
                testResults.push('âŒ InitVarè§£ææµ‹è¯•å¤±è´¥');
                failed++;
            }
            
            // æµ‹è¯•3: UpdateVariableå—
            try {
                const handler = new MockWorldbookHandler();
                const blocks = handler.parseUpdateVariableBlock('<UpdateVariable>test</UpdateVariable>');
                if (blocks.length > 0) {
                    testResults.push('âœ… UpdateVariableå—æµ‹è¯•é€šè¿‡');
                    passed++;
                }
            } catch {
                testResults.push('âŒ UpdateVariableå—æµ‹è¯•å¤±è´¥');
                failed++;
            }
            
            // æ±‡æ€»ç»“æœ
            const summary = `\n========== æµ‹è¯•ç»“æœ ==========\næ€»è®¡: ${passed + failed} | é€šè¿‡: ${passed} | å¤±è´¥: ${failed}\nå…¼å®¹æ€§è¯„åˆ†: ${Math.round(passed / (passed + failed) * 100)}%`;
            
            result.className = failed === 0 ? 'result success' : 'result warning';
            result.innerHTML = testResults.join('\n') + summary;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç¯å¢ƒæ£€æŸ¥
        window.onload = () => {
            checkEnvironment();
        };
    </script>
</body>
</html>
